{{> head}}
{{> navbar}}


<main class="post">
   {{#if @customHTML.beforePost}}
      <div class="banner banner--before-content">
         {{{@customHTML.beforePost }}}
      </div>
   {{/if}}
   {{#post}}
      <article class="content {{#isFeatured}}content--featured{{/isFeatured}} wrapper">
         <header class="hero">
            {{#checkIfAny @config.post.displayAuthor @config.post.displayDate}}
               <p class="content__meta">
                  {{#if @config.post.displayAuthor}}
                     {{#author}}
                        {{ translate 'post.publishedBy' }}
                        <a href="{{url}}" rel="author" title="{{name}}">{{name}}</a>
                     {{/author}}
                  {{/if}}
                  {{#if @config.post.displayDate}}
                     {{ translate 'post.publishedOn' }}
                     <time datetime="{{date createdAt 'YYYY-MM-DDTHH:mm'}}">
                        {{#checkIf @config.custom.formatDate '!=' 'custom'}}
                           {{date createdAt @config.custom.formatDate}}
                        {{else}}
                           {{date createdAt @config.custom.formatDateCustom}}
                        {{/checkIf}}
                     </time>
                  {{/if}}
               </p>
            {{/checkIfAny}}
            <h1 class="content__title">{{title}}</h1>
         </header>
         {{#featuredImage}}
            {{#if url}}               
              <figure class="content__featured-image {{@config.post.featuredImageWidth}}">
                 <img
                    src="{{url}}"
                    {{#if @config.site.responsiveImages}}                           
                        {{responsiveImageAttributes 'featuredImage' srcset.post sizes.post}}
                    {{/if}}
                    {{ lazyload "eager" }}
                    height="{{height}}"
                    width="{{width}}"
                    alt="{{alt}}">

                 {{#checkIfAny caption credits}}
                    <figcaption>
                       {{caption}}
                       {{credits}}
                    </figcaption>                      
                 {{/checkIfAny}}
              </figure>               
            {{/if}}
         {{/featuredImage}}
         <div class="content__entry">
            {{{text}}}
         </div>
         {{#checkIfAny @config.post.displayLastUpdatedDate @config.post.displayTags @config.post.displayshareButtons @config.post.displayPostNavigation @config.post.displayAuthorBio @config.post.displayRelatedPosts}}
            <footer class="content__footer">
               {{#if @config.post.displayLastUpdatedDate}}
                  {{#if modifiedAt}}
                     <div class="content__last-updated">
                        {{ translate 'post.lastUpdatedDate' }}

                        {{#checkIf @config.custom.formatDate '!=' 'custom'}}
                           {{date modifiedAt @config.custom.formatDate}}
                        {{else}}
                           {{date modifiedAt @config.custom.formatDateCustom}}
                        {{/checkIf}}

                     </div>
                  {{/if}}
               {{/if}}

               {{#checkIfAny @config.post.displayTags @config.post.displayShareButtons}}
                  <div class="content__footer__col">
                     {{#if @config.post.displayTags}}
                        {{#if tags}}
                           <ul class="content__tag">
                              {{#each tags}}
                                 <li>
                                    <a href="{{url}}">{{name}}</a>
                                 </li>
                              {{/each}}
                           </ul>
                        {{/if}}
                     {{/if}}
                     {{#if @config.post.displayShareButtons}}
                        {{#checkIfAll @plugins.socialSharing @plugins.socialSharing.state}}
                           <div class="content__share">
                              {{{@customSocialSharing}}}
                           </div>
                        {{else}}
                           <div class="content__share">
                              {{> share-buttons}}
                           </div>
                        {{/checkIfAll}}          
                     {{/if}}
                  </div>
               {{/checkIfAny}}

               {{#if @config.post.displayPostNavigation}}
                  {{#checkIfAny ../previousPost ../nextPost}}
                     <nav class="content__nav">
                        {{#../previousPost}}
                           <div class="content__nav__prev">
                              {{ translate 'post.previousPost' }}
                              <h5>
                                 <a href="{{url}}" class="invert" rel="prev">
                                    {{title}}
                                 </a>
                              </h5>
                           </div>
                        {{/../previousPost}}
                        {{#../nextPost}}
                           <div class="content__nav__next">
                              {{ translate 'post.nextPost' }}
                              <h5>
                                 <a href="{{url}}" class="invert" rel="next">
                                    {{title}}
                                 </a>
                              </h5>
                           </div>
                        {{/../nextPost}}
                     </nav>
                  {{/checkIfAny}}
               {{/if}}

               {{#if @config.post.displayAuthorBio}}
                  {{#author}}
                     <div class="content__bio">
                        {{#if avatar}}                          
                           <img 
                              src="{{avatarImage.url}}" 
                              {{ lazyload "eager" }}
                              height="{{avatarImage.height}}"
                              width="{{avatarImage.width}}"
                              alt="{{avatarImage.alt}}">                      
                        {{/if}}
                        <div>
                           {{#if name}}
                              <h3>
                                 <a href="{{url}}" class="invert" title="{{name}}">{{name}}</a>
                              </h3>
                           {{/if}}

                           {{{description}}}
                        </div>
                     </div>
                  {{/author}}
               {{/if}}

               {{#if @config.post.displayRelatedPosts}}
                  {{#if ../relatedPosts}}
                     <div class="content__related">
                        <h3 class="u-h5">
                           {{ translate 'post.relatedPosts' }}
                        </h3>
                        <div class="content__related__wrap">
                           {{#each ../relatedPosts}}
                              <figure>
                                 {{#featuredImage}}
                                    {{#if url}}                                      
                                      <a href="{{../url}}">
                                         <img 
                                             {{#if @config.site.responsiveImages}}                           
                                                src="{{urlXs}}"
                                             {{else}}
                                                src="{{url}}"
                                             {{/if}}
                                             {{ lazyload "lazy" }}
                                             alt="{{alt}}">
                                      </a>                                       
                                    {{/if}}
                                 {{/featuredImage}}
                                 <figcaption>
                                    <h4>
                                       <a href="{{url}}" class="invert">{{title}}</a>
                                    </h4>
                                    <time datetime="{{date createdAt 'YYYY-MM-DDTHH:mm'}}">
                                       {{#checkIf @config.custom.formatDate '!=' 'custom'}}
                                          {{date createdAt @config.custom.formatDate}}
                                       {{else}}
                                          {{date createdAt @config.custom.formatDateCustom}}
                                       {{/checkIf}}
                                    </time>
                                 </figcaption>
                              </figure>
                           {{/each}}
                        </div>
                     </div>
                  {{/if}}
               {{/if}}
            </footer>
         {{/checkIfAny}}
      </article>
	  

// THIS IS WHERE THE PUBLII MASTODON STATIC COMMENTS STUFF STARTS. 

<section id="masto-comments-section" style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
    <div id="masto-comments-wrapper">
        <h2>Comments</h2>
        
        <div id="masto-join-link" style="display:none;">
            <p><a id="masto-url" href="#" target="_blank" class="button">
                Join the conversation on Mastodon
            </a> or send me a comment <a href="https://pomnavi.net/#contact">here</a></p>
        </div>
        
        <div id="masto-stats" style="margin-bottom: 25px; display: none; gap: 20px; font-size: 0.9rem; color: #666; align-items: center;">
            <span class="masto-stat-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span id="masto-replies-count">0</span>
            </span>
            <span class="masto-stat-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                <span id="masto-boosts-count">0</span>
            </span>
            <span class="masto-stat-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                <span id="masto-favs-count">0</span>
            </span>
        </div>

        <div id="mastodon-comments-list">Loading comments...</div>
    </div>
	
	 <style>
        .masto-comment { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #fff; }
        .masto-avatar { width: 48px !important; height: 48px !important; border-radius: 50%; float: left; margin-right: 15px; display: block !important; }
        .masto-comment-header { display: flex; align-items: center; margin-bottom: 10px; }
        .masto-indent-1 { margin-left: 20px; border-left: 2px solid #eee; padding-left: 10px; }
		.masto-indent-2 { margin-left: 40px; border-left: 2px solid #eee; padding-left: 10px; }
		.masto-indent-3 { margin-left: 60px; border-left: 2px solid #eee; padding-left: 10px; }
        .masto-content { clear: both; margin-top: 10px; }
		.masto-date {
				font-size: 0.8rem !important;
				color: #888 !important;
				margin-top: 2px !important;
				text-transform: uppercase; /* Optional: makes the AM/PM look cleaner */
				letter-spacing: 0.02em;
				display: inline !important;
			}
		.masto-meta {
				display: flex !important;
				flex-direction: column !important;
				justify-content: center !important;
			}
		.masto-handle {
				font-size: 0.8rem !important;
				color: #777 !important;
			}
			
			.masto-stat-item {
				display: flex;
				align-items: center;
				gap: 6px;
				background: #f4f4f7;
				padding: 5px 12px;
				border-radius: 100px;
				transition: background 0.2s;
			}

			.masto-stat-item svg {
				color: #595aff; /* Mastodon Purple */
				display: block;
			}

			.masto-stat-item span {
				font-weight: 600;
				color: #444;
			}

			/* Optional: Slight hover effect */
			.masto-stat-item:hover {
				background: #e8e8ff;
			}
			.masto-author-row {
				display: flex;
				align-items: center;
				gap: 8px;
			}

			.masto-badge {
				background: #595aff;
				color: #fff;
				font-size: 0.65rem;
				font-weight: 800;
				text-transform: uppercase;
				padding: 3px 8px;
				border-radius: 4px;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}
			
			/* --- Light Mode (Default) --- */
			.masto-owner {
				background-color: rgba(89, 90, 255, 0.05);
				border: 1px solid rgba(89, 90, 255, 0.15);
				border-radius: 12px;
				padding: 15px !important;
				margin-bottom: 15px;
			}

			/* --- Dark Mode --- */
			@media (prefers-color-scheme: dark) {
				.masto-owner {
					/* Use a slightly stronger purple tint for dark backgrounds */
					background-color: rgba(89, 90, 255, 0.12) !important;
					/* Brighter, more visible border for dark mode */
					border: 1px solid rgba(89, 90, 255, 0.3) !important;
				}
				
				/* Ensure the author handle and date remain legible */
				.masto-owner .masto-handle, 
				.masto-owner .masto-date {
					color: #aaa !important;
				}

				/* Make the Author Badge pop a bit more */
				.masto-badge {
					box-shadow: 0 0 8px rgba(89, 90, 255, 0.4);
				}
			}
			
			.masto-attachments {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				margin-top: 10px;
			}

			.masto-attached-img {
				max-width: 200px;
				max-height: 200px;
				border-radius: 8px;
				border: 1px solid rgba(0,0,0,0.1);
				object-fit: cover;
				transition: opacity 0.2s;
			}

			.masto-attached-img:hover {
				opacity: 0.8;
			}

			/* Dark mode border adjustment */
			@media (prefers-color-scheme: dark) {
				.masto-attached-img {
					border-color: rgba(255,255,255,0.1);
				}
			}
    </style>

   <script>
document.addEventListener("DOMContentLoaded", function() {
    const mIdRaw = "{{@config.post.mastodonId}}";
    const mId = (mIdRaw && mIdRaw !== "undefined" && mIdRaw !== "[object Object]") ? mIdRaw : null;
    const wrapper = document.getElementById('masto-comments-section');

    if (mId && mId.trim().length > 0) {
        // Prepare to fetch both files
        const mastoUrl = `/media/files/comments/${mId}.json`;
        const manualUrl = `/media/files/comments/${mId}-manual.json`;

        // Fetch both (using allSettled so it doesn't crash if manual file is missing)
        Promise.allSettled([
            fetch(mastoUrl).then(r => r.ok ? r.json() : { descendants: [] }),
            fetch(manualUrl).then(r => r.ok ? r.json() : { descendants: [] })
        ]).then(results => {
            const mastoData = results[0].status === 'fulfilled' ? results[0].value : {};
            const manualData = results[1].status === 'fulfilled' ? results[1].value : { descendants: [] };

            const container = document.getElementById('mastodon-comments-list');
            
            // 1. Stats Bar (Mastodon only)
            const statsBar = document.getElementById('masto-stats');
            if (statsBar && mastoData.url) {
                document.getElementById('masto-replies-count').innerText = mastoData.replies_count || 0;
                document.getElementById('masto-boosts-count').innerText = mastoData.reblogs_count || 0;
                document.getElementById('masto-favs-count').innerText = mastoData.favourites_count || 0;
                statsBar.style.display = 'flex';
            }

            // 2. Combine all comments
            const allReplies = [
                ...(mastoData.descendants || []),
                ...(manualData.descendants || [])
            ];

            // 3. Threading & Rendering
            const commentMap = {};
            allReplies.forEach(r => {
                commentMap[r.id] = { ...r, children: [] };
            });

            const threaded = [];
            allReplies.forEach(r => {
                if (r.in_reply_to_id && commentMap[r.in_reply_to_id]) {
                    commentMap[r.in_reply_to_id].children.push(commentMap[r.id]);
                } else {
                    threaded.push(commentMap[r.id]);
                }
            });

            // Sort top-level comments by date
            threaded.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            function render(comment, depth = 0) {
                const commentDate = new Date(comment.created_at).toLocaleString(undefined, {
                    month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const indentClass = depth > 0 ? `masto-indent-${Math.min(depth, 3)}` : '';
                const isAuthor = comment.account.acct.toLowerCase().includes('navi');
                const isManual = comment.id.toString().startsWith('manual-');

                return `
                    <div class="masto-comment ${indentClass} ${isAuthor ? 'masto-owner' : ''}">
                        <div class="masto-comment-header">
                            <img src="${comment.account.avatar}" class="masto-avatar">
                            <div class="masto-meta">
                                <div class="masto-author-row">
                                    <span class="masto-author">${comment.account.display_name}</span>
                                    ${isAuthor ? '<span class="masto-badge">Author</span>' : ''}
                                    ${isManual ? '<span class="masto-badge" style="background:#444">Manual</span>' : ''}
                                </div>
                                <span class="masto-handle">
                                    @${comment.account.acct} â€¢ <span class="masto-date">${commentDate}</span>
                                </span>
                            </div>
                        </div>
                        <div class="masto-content">${comment.content}</div>
                    </div>
                    ${comment.children.map(child => render(child, depth + 1)).join('')}
                `;
            }

            container.innerHTML = threaded.length > 0 ? threaded.map(c => render(c)).join('') : '<p>No comments yet.</p>';
            
            // Show join link
            document.getElementById('masto-join-link').style.display = 'block';
            document.getElementById('masto-url').href = mastoData.url || "#";
        });
    } else {
        if (wrapper) wrapper.style.display = 'none';
    }
});
</script>
</section>

// THIS IS WHERE THE PUBLII MASTODON STATIC COMMENTS STUFF ENDS.

      {{#if @config.post.displayComments}}
         <div class="comments-area wrapper">
            {{{@commentsCustomCode}}}
         </div>
      {{/if}}

      {{#if @customHTML.afterPost}}
         <div class="banner banner--after-content">
            {{{@customHTML.afterPost}}}
         </div>
      {{/if}}
   {{/post}}
</main>
{{> footer}}
